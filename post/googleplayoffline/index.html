<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Xun&#39;s Blog  | GooglePlay——离线配置</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link rel="stylesheet" href="https://fallingxun.github.io/css/blog.css" />
    </head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="https://fallingxun.github.io/">Home</a>
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(https://fallingxun.github.io/img/bg-blog.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        GooglePlay——离线配置
                    
                </h1>
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <p>谷歌unity的登录和IAP支付插件，很多设置需要在联网状态下进行，离线状态下，不能直接应用，需要进一步进行处理。</p>
<h3 id="踩坑点">踩坑点</h3>
<ol>
<li><strong>UnityEditor.Purchasing.dll</strong>：编辑器下的工具库，会自动对 UnityEngine.Purchasing.dll 的平台环境进行设置，需要在Service视窗里进行开关设置。</li>
</ol>
<blockquote>
<p>**存在问题：**默认情况下会关闭Editor平台，所以编辑器下不能正常调用对应的类和方法。自行设置后，重新导入后会被重置，出现编译报错。关闭此dll的话会引起其他引用丢失，同样会有编译报错。
**解决方法：**将IAP的package移到Packages文件夹下，修改 UnityEngine.Purchasing.dll.meta 里的guid，防止被自动检测修改设置，然后自行设置所需的平台。</p>
</blockquote>
<ol start="2">
<li><strong>Play Services Resolver</strong> 机制：谷歌为unity提供的管理项目的库的机制，能防止库的多版本引用冲突。</li>
</ol>
<blockquote>
<p>**存在问题：**编译成功等多种情况下会触发，触发的时候会删除本地所有带有Gspr标签的库，然后根据 **Dependences.xml重新从远程仓库拉取整合，离线状态下则只能进行删除操作，并不能重新生成，导致库丢失。
**解决方法：**关闭此项机制。
<img src="https://github.com/FallingXun/FallingXun.github.io/blob/master/images/GooglePlay/Offline/1.png" alt="1.png">
<img src="https://github.com/FallingXun/FallingXun.github.io/blob/master/images/GooglePlay/Offline/2.png" alt="2.png"></p>
</blockquote>
<ol start="3">
<li>**安卓库管理：**引入多方插件的时候容易产生库冲突，需要自行维护所有相关的安卓库</li>
</ol>
<blockquote>
<p>**存在问题：**本人测试出现tpns-release.aar里的华为相关库和android-support-v4.jar里的部分类重复或冲突。
**解决方法：**删除tpns-release.aar，删除android-support-v4.jar里的部分重复类，但这是临时方案，后续需要进行系统的规划。</p>
</blockquote>
<h3 id="后续操作">后续操作</h3>
<ol>
<li>新增或删除第三方插件时，需要导入渠道sdk的接入工程里编译，检查是否会有冲突的，重新生成渠道的配置。</li>
<li>更换正式的谷歌配置信息时，需要重新生成配置文件。</li>
<li>谷歌相关的所有资源，需要剥离出去，构建的时候再拷贝回去，总共有以下几项</li>
</ol>
<blockquote>
<p>Project/Assets/Scripts/SDK/Channel/Agent/ChannelAgentGooglePlay.cs （渠道的调用代码）
Project/Assets/ExternalDependencyManager/ （后续考虑移除此部分模块，不使用Resolver）
Project/Assets/GooglePlayGames/
Project/Assets/Plugins/
<a href="mailto:Project/Packages/com.unity.purchasing@2.0.3">Project/Packages/com.unity.purchasing@2.0.3</a>/
Project/ProjectSettings/AndroidResolverDependencies.xml
Project/ProjectSettings/GvhProjectSettings.xml
Project/ProjectSettings/GooglePlayGameSettings.xml</p>
</blockquote>
<ol start="4">
<li>构建线配合需求：</li>
</ol>
<blockquote>
<p>回滚工程，删除非版本文件，包括非Assets文件夹下的文件
按渠道划分，构建时拷贝渠道的文件到对应的目录下
游戏包的初始配置，VersionConfig的相关配置信息设置，后续应该会扩展，目前需要：</p>
<blockquote>
<p>mStartPlatformType（启动平台类型）
mTargetPlatformTypes（所有目标类型平台）
mLoginIp（登录服ip）
mLoginPort（登录服端口）</p>
</blockquote>
</blockquote>
            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/googleplay">googleplay</a></span>
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/gp">gp</a></span>
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/tmp">tmp</a></span>
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/unity%E5%A0%86%E5%86%85%E5%AD%98">unity堆内存</a></span>
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/%E4%BC%98%E5%8C%96">优化</a></span>
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/%E6%8A%95%E5%BD%B1">投影</a></span>
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/%E6%8F%8F%E8%BE%B9">描边</a></span>
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/%E6%94%AF%E4%BB%98">支付</a></span>
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/%E7%99%BB%E5%BD%95">登录</a></span>
        
            <span class="tag"><a href="https://fallingxun.github.io/tags/%E7%A6%BB%E7%BA%BF">离线</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="https://fallingxun.github.io/post/googleplayoffline/">GooglePlay——离线配置</a></h1>
            <time class="has-text-grey-light is-size-7">5 July 2021</time>
        
            <h1><a href="https://fallingxun.github.io/post/googleplaylogin/">GooglePlay——登录篇</a></h1>
            <time class="has-text-grey-light is-size-7">5 July 2021</time>
        
            <h1><a href="https://fallingxun.github.io/post/googleplaypay/">GooglePlay——支付篇</a></h1>
            <time class="has-text-grey-light is-size-7">5 July 2021</time>
        
            <h1><a href="https://fallingxun.github.io/post/textmeshoutline/">TMP(TextMeshPro)优化篇——描边投影效果</a></h1>
            <time class="has-text-grey-light is-size-7">8 February 2021</time>
        
            <h1><a href="https://fallingxun.github.io/post/textmeshprogcoptimize/">TMP(TextMeshPro)优化篇——堆内存</a></h1>
            <time class="has-text-grey-light is-size-7">7 February 2021</time>
        
    </div>
</div>
    <br>
                
  



<div class="card">
    <div class="card-content">
        <h1 class="title is-5">Related posts</h1>
      
      
            <h1><a href="https://fallingxun.github.io/post/googleplaypay/">GooglePlay——支付篇</a></h1>
            <time class="has-text-grey-light is-size-7">5 July 2021</time>
      
            <h1><a href="https://fallingxun.github.io/post/googleplaylogin/">GooglePlay——登录篇</a></h1>
            <time class="has-text-grey-light is-size-7">5 July 2021</time>
      
    </div>
</div>

    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="https://fallingxun.github.io/archives/2021">2021</a> (5)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://twitter.com/" class="mysocial" rel="me"><i class="fab fa-twitter fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="https://www.youtube.com/" class="mysocial" rel="me"><i class="fab fa-youtube fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="https://github.com/" class="mysocial" rel="me"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; Xun&#39;s Blog 2021 - Theme by <a href="https://jeffprod.com" class="mysocial">JeffProd.com</a>
            - <a class="mysocial" href="https://fallingxun.github.io/about">About</a>
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
</body>
</html>
