<!doctype html><html lang=zh-cn>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1">
<meta property="og:site_name" content="Xun's Blog">
<meta property="og:type" content="article">
<meta property="og:image" content="https://fallingxun.github.io//">
<meta property="twitter:image" content="https://fallingxun.github.io//">
<meta name=title content="Lua篇 — (3) xLua">
<meta property="og:title" content="Lua篇 — (3) xLua">
<meta property="twitter:title" content="Lua篇 — (3) xLua">
<meta name=description content>
<meta property="og:description" content>
<meta property="twitter:description" content>
<meta property="twitter:card" content="summary">
<meta name=keyword content>
<link rel="shortcut icon" href=/img/favicon.ico>
<title>Lua篇 — (3) xLua-</title>
<link rel=canonical href=/post/lua/lua_xlua/>
<link rel=stylesheet href=/css/iDisqus.min.css>
<link rel=stylesheet href=/css/bootstrap.min.css>
<link rel=stylesheet href=/css/hugo-theme-cleanwhite.min.css>
<link rel=stylesheet href=/css/zanshang.css>
<link href=//cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css rel=stylesheet type=text/css>
<script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js></script>
<script src=/js/hux-blog.min.js></script>
</head>
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
<div class=container-fluid>
<div class="navbar-header page-scroll">
<button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=/>Xun's Blog</a>
</div>
<div id=huxblog_navbar>
<div class=navbar-collapse>
<ul class="nav navbar-nav navbar-right">
<li>
<a href=/>Home</a>
</li>
<li>
<a href=/categories/googleplay%E7%B3%BB%E5%88%97>googleplay系列</a>
</li>
<li>
<a href=/categories/lua%E7%B3%BB%E5%88%97>lua系列</a>
</li>
<li>
<a href=/categories/tmp%E7%B3%BB%E5%88%97>tmp系列</a>
</li>
</ul>
</div>
</div>
</div>
</nav>
<script>var $body=document.body,$toggle=document.querySelector('.navbar-toggle'),$navbar=document.querySelector('#huxblog_navbar'),$collapse=document.querySelector('.navbar-collapse');$toggle.addEventListener('click',handleMagic);function handleMagic(a){$navbar.className.indexOf('in')>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf('in')<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script>
<style type=text/css>header.intro-header{background-image:url('/')}</style>
<header class=intro-header>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<div class=post-heading>
<div class=tags>
<a class=tag href=/tags/lua title=Lua>
Lua
</a>
<a class=tag href=/tags/xlua title=xLua>
xLua
</a>
</div>
<h1>Lua篇 — (3) xLua</h1>
<h2 class=subheading></h2>
<span class=meta>
Posted by
Xun
on
Thursday, November 4, 2021
</span>
</div>
</div>
</div>
</div>
</header>
<article>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container">
<p>由于很多旧项目是以CSharp开发的，热更时就会遇到难题。而xLua框架的出现，让很多项目能够在改动最小的情况下，支持热更新功能。</p>
<h3 id=简介>简介</h3>
<h3 id=初始化>初始化</h3>
<h4 id=创建luaenv>创建LuaEnv</h4>
<ul>
<li>Lua状态机的创建方法主要实现如下</li>
</ul>
<pre tabindex=0><code>    public LuaEnv()
    {

        ...
                
        rawL = LuaAPI.luaL_newstate();

        //Init Base Libs
        LuaAPI.luaopen_xlua(rawL);
        LuaAPI.luaopen_i64lib(rawL);

        translator = new ObjectTranslator(this, rawL);
        translator.createFunctionMetatable(rawL);
        translator.OpenLib(rawL);
        ObjectTranslatorPool.Instance.Add(rawL, translator);

        LuaAPI.lua_atpanic(rawL, StaticLuaCallbacks.Panic);

#if !XLUA_GENERAL
        LuaAPI.lua_pushstdcallcfunction(rawL, StaticLuaCallbacks.Print);
        if (0 != LuaAPI.xlua_setglobal(rawL, &quot;print&quot;))
        {
            throw new Exception(&quot;call xlua_setglobal fail!&quot;);
        }
#endif

        //template engine lib register
        TemplateEngine.LuaTemplate.OpenLib(rawL);

        AddSearcher(StaticLuaCallbacks.LoadBuiltinLib, 2); // just after the preload searcher
        AddSearcher(StaticLuaCallbacks.LoadFromCustomLoaders, 3);
#if !XLUA_GENERAL
        AddSearcher(StaticLuaCallbacks.LoadFromResource, 4);
        AddSearcher(StaticLuaCallbacks.LoadFromStreamingAssetsPath, -1);
#endif
        DoString(init_xlua, &quot;Init&quot;);
        init_xlua = null;

#if (!UNITY_SWITCH &amp;&amp; !UNITY_WEBGL) || UNITY_EDITOR
        AddBuildin(&quot;socket.core&quot;, StaticLuaCallbacks.LoadSocketCore);
        AddBuildin(&quot;socket&quot;, StaticLuaCallbacks.LoadSocketCore);
#endif

        AddBuildin(&quot;CS&quot;, StaticLuaCallbacks.LoadCS);

        LuaAPI.lua_newtable(rawL); //metatable of indexs and newindexs functions
        LuaAPI.xlua_pushasciistring(rawL, &quot;__index&quot;);
        LuaAPI.lua_pushstdcallcfunction(rawL, StaticLuaCallbacks.MetaFuncIndex);
        LuaAPI.lua_rawset(rawL, -3);

        LuaAPI.xlua_pushasciistring(rawL, Utils.LuaIndexsFieldName);
        LuaAPI.lua_newtable(rawL);
        LuaAPI.lua_pushvalue(rawL, -3);
        LuaAPI.lua_setmetatable(rawL, -2);
        LuaAPI.lua_rawset(rawL, LuaIndexes.LUA_REGISTRYINDEX);

        LuaAPI.xlua_pushasciistring(rawL, Utils.LuaNewIndexsFieldName);
        LuaAPI.lua_newtable(rawL);
        LuaAPI.lua_pushvalue(rawL, -3);
        LuaAPI.lua_setmetatable(rawL, -2);
        LuaAPI.lua_rawset(rawL, LuaIndexes.LUA_REGISTRYINDEX);

        LuaAPI.xlua_pushasciistring(rawL, Utils.LuaClassIndexsFieldName);
        LuaAPI.lua_newtable(rawL);
        LuaAPI.lua_pushvalue(rawL, -3);
        LuaAPI.lua_setmetatable(rawL, -2);
        LuaAPI.lua_rawset(rawL, LuaIndexes.LUA_REGISTRYINDEX);

        LuaAPI.xlua_pushasciistring(rawL, Utils.LuaClassNewIndexsFieldName);
        LuaAPI.lua_newtable(rawL);
        LuaAPI.lua_pushvalue(rawL, -3);
        LuaAPI.lua_setmetatable(rawL, -2);
        LuaAPI.lua_rawset(rawL, LuaIndexes.LUA_REGISTRYINDEX);

        LuaAPI.lua_pop(rawL, 1); // pop metatable of indexs and newindexs functions

        LuaAPI.xlua_pushasciistring(rawL, MAIN_SHREAD);
        LuaAPI.lua_pushthread(rawL);
        LuaAPI.lua_rawset(rawL, LuaIndexes.LUA_REGISTRYINDEX);

        LuaAPI.xlua_pushasciistring(rawL, CSHARP_NAMESPACE);
        if (0 != LuaAPI.xlua_getglobal(rawL, &quot;CS&quot;))
        {
            throw new Exception(&quot;get CS fail!&quot;);
        }
        LuaAPI.lua_rawset(rawL, LuaIndexes.LUA_REGISTRYINDEX);

#if !XLUA_GENERAL &amp;&amp; (!UNITY_WSA || UNITY_EDITOR)
        translator.Alias(typeof(Type), &quot;System.MonoType&quot;);
#endif

        if (0 != LuaAPI.xlua_getglobal(rawL, &quot;_G&quot;))
        {
            throw new Exception(&quot;get _G fail!&quot;);
        }
        translator.Get(rawL, -1, out _G);
        LuaAPI.lua_pop(rawL, 1);

        errorFuncRef = LuaAPI.get_error_func_ref(rawL);

        if (initers != null)
        {
            for (int i = 0; i &lt; initers.Count; i++)
            {
                initers[i](this, translator);
            }
        }

        translator.CreateArrayMetatable(rawL);
        translator.CreateDelegateMetatable(rawL);
        translator.CreateEnumerablePairs(rawL);
    }

</code></pre><ul>
<li>xLua的状态机构造函数比较庞大，将所有初始化操作全部集中在这里，接下来将逐一来分析其作用（以lua-5.3.5为例）。</li>
<li></li>
<li>LuaAPI.luaopen_xlua
<ul>
<li>初始化lua侧的基本库，包括package、coroutine、table、io、os、string、math、utf8、debug等。</li>
</ul>
</li>
<li>LuaAPI.luaopen_i64lib
<ul>
<li>初始化64位整型，包括int64和uint64。</li>
</ul>
</li>
</ul>
<h4 id=objecttranslator>ObjectTranslator</h4>
<ul>
<li>ObjectTranslator中进行了一些初始化操作，主要为：
<ul>
<li>缓存程序集，包括当前运行的程序集、mscorlib、System、System.Core。</li>
<li>创建ObjectCaster，初始化基本类型、LuaTable、LuaFunction的转化委托（返回object）。</li>
<li>创建ObjectCheckers，初始化基本类型、LuaTable、LuaFunction的类型检查。</li>
<li>创建MethodWrapsCache，建立运行时方法Wrap的缓存。</li>
<li>创建StaticLuaCallbacks，将一些常用的方法转成LuaFunction：
<ul>
<li>LuaGC：lua对象gc回收。</li>
<li>ToString：调用CSharp的ToString。</li>
<li>EnumAnd：枚举与操作。</li>
<li>EnumOr：枚举或操作。</li>
<li>StaticCSFunction：lua方法委托。</li>
<li>FixCSFunction：lua修复的方法委托。</li>
<li>DelegateConstructor：委托构造方法。</li>
</ul>
</li>
<li>将一些特殊方法转成LuaFunction：
<ul>
<li>StaticLuaCallbacks.ImportType：注册CSharp的class到lua侧。</li>
<li>StaticLuaCallbacks.LoadAssembly：加载程序集到ObjectTranslator.assemblies。</li>
<li>StaticLuaCallbacks.Cast：将某个对象的metatable设置为CSharp的class。</li>
</ul>
</li>
<li>创建一个表放入 LUA_REGISTRYINDEX 表，再创建一个值弱表（{__mode = &ldquo;v&rdquo;}），设置为此表的metatable。</li>
<li>创建function的metatable，包含__gc方法，放入 LUA_REGISTRYINDEX 表。</li>
<li>注册方法到lua侧：
<ul>
<li>xlua.import_type：CSharp侧的StaticLuaCallbacks.ImportType。</li>
<li>xlua.import_generic_type：CSharp侧的StaticLuaCallbacks.ImportGenericType。</li>
<li>xlua.cast：CSharp侧的StaticLuaCallbacks.Cast。</li>
<li>xlua.load_assembly：CSharp侧的StaticLuaCallbacks.LoadAssembly。</li>
<li>xlua.access：CSharp侧的StaticLuaCallbacks.XLuaAccess。</li>
<li>xlua.private_accessible：CSharp侧的StaticLuaCallbacks.XLuaPrivateAccessible。</li>
<li>xlua.metatable_operation：CSharp侧的StaticLuaCallbacks.XLuaMetatableOperation。</li>
<li>xlua.tofunction：CSharp侧的StaticLuaCallbacks.ToFunction。</li>
<li>xlua.get_generic_method：CSharp侧的StaticLuaCallbacks.GetGenericMethod。</li>
<li>xlua.release：CSharp侧的StaticLuaCallbacks.ReleaseCsObject。</li>
</ul>
</li>
<li>创建新表存入 LUA_REGISTRYINDEX 表，作为array的metatable。</li>
<li>创建新表存入 LUA_REGISTRYINDEX 表，delegate的metatable。</li>
</ul>
</li>
</ul>
<h4 id=初始化lua环境>初始化lua环境</h4>
<ul>
<li>执行 init_xlua 脚本，对lua环境进行初始化：
<ul>
<li>创建 CS 表，设置metatable方法：
<ul>
<li>__index方法：查找对应的类型，如：CS.UnityEngine.GameObject，则调起 StaticLuaCallbacks.ImportType，将CSharp侧的类注册到lua侧，并将此类型缓存到 CS 表中。</li>
<li>__newindex方法：输出报错信息，当前没有这个类型。</li>
<li>__call方法：泛型类对象获取，如：CS.System.Collections.Generic.List(CS.System.String)，则会调起 StaticLuaCallbacks.ImportGenericType，获取指定类型的泛型type。由于每次调用都会触发 StaticLuaCallbacks.ImportGenericType 方法，而此方法中使用Type.MakeGenericType来构造泛型对象，需要创建Type数组，所以会有gc产生，可以缓存对象重复使用。</li>
</ul>
</li>
<li>注册 typeof 方法为CSharp的 Type.UnderlyingSystemType。</li>
<li>注册 setfenv 和 getfenv 方法。</li>
<li>注册 xlua.hotfix 方法，可以进行热修复。</li>
<li>注册 xlua.setmetatable 方法为 xlua.metatable_operation(cs)。</li>
<li>注册 xlua.setmetatable 方法为 xlua.metatable_operation(cs, mt)。</li>
<li>注册 xlua.setclass 方法，可实现CSharp的class或者struct在lua侧改造。</li>
<li>注册 base 方法，可实现调用CSharp父类对象方法（Hotfix.BASE_RPOXY_PERFIX标识）。</li>
</ul>
</li>
</ul>
<h4 id=方法设置>方法设置</h4>
<ul>
<li>注册lua侧的print方法为CSharp侧的StaticLuaCallbacks.Print。</li>
<li>设置lua侧的package.seachers方法，用于require调起：
<ul>
<li>package.seachers[2]（即 searcher_Lua）设置为CSharp侧的StaticLuaCallbacks.LoadBuiltinLib。</li>
<li>package.seachers[3]（即 searcher_C）设置为CSharp侧的StaticLuaCallbacks.LoadFromCustomLoaders。</li>
<li>package.seachers[4]（即 searcher_Croot）设置为CSharp侧的StaticLuaCallbacks.LoadFromResource。</li>
<li>package.seachers[5]（即 NULL）设置为CSharp侧的StaticLuaCallbacks.LoadFromStreamingAssetsPath。</li>
</ul>
</li>
<li>设置CSharp侧LoadBuiltinLib的查找字典LuaEnv.buildin_initer，当调用package.seachers[2]时，会从字典中中找：
<ul>
<li>socket.core：CSharp侧的StaticLuaCallbacks.LoadSocketCore。</li>
<li>socket：CSharp侧的StaticLuaCallbacks.LoadSocketCore。</li>
<li>CS：CSharp侧的StaticLuaCallbacks.LoadCS，获取 LUA_REGISTRYINDEX 表里的 xlua_csharp_namespace 表。</li>
</ul>
</li>
<li>设置index和newindex相关表：
<ul>
<li>创建新表meta，设置 __index 方法为CSharp侧的 StaticLuaCallbacks.MetaFuncIndex，查找当前表里对应type的内容。</li>
<li>创建新表，key值为 LuaIndexs，存入 LUA_REGISTRYINDEX 中，设置其metatable为meta表。</li>
<li>创建新表，key值为 LuaNewIndexs，存入 LUA_REGISTRYINDEX 中，设置其metatable为meta表。</li>
<li>创建新表，key值为 LuaClassIndexs，存入 LUA_REGISTRYINDEX 中，设置其metatable为meta表。</li>
<li>创建新表，key值为 LuaClassNewIndexs，存入 LUA_REGISTRYINDEX 中，设置其metatable为meta表。</li>
</ul>
</li>
<li>设置主线程到 LUA_REGIXTRYINDEX 中，key值为 xlua_main_thread。</li>
<li>将 _G 中的 CS 表，存入 LUA_REGISTRYINDEX 中，key值为 xlua_csharp_namespace。</li>
</ul>
<h3 id=访问对象>访问对象</h3>
<h4 id=lua访问csharp对象>Lua访问CSharp对象</h4>
<h4 id=csharp访问lua对象>CSharp访问Lua对象</h4>
<h4 id=时序图>时序图</h4>
<h3 id=调用方法>调用方法</h3>
<h4 id=lua调用csharp方法>Lua调用CSharp方法</h4>
<h4 id=csharp调用lua方法>CSharp调用Lua方法</h4>
<h3 id=委托>委托</h3>
<h3 id=重载>重载</h3>
<h3 id=无gc传值>无GC传值</h3>
<h3 id=泛型>泛型</h3>
<h3 id=反射>反射</h3>
<h3 id=64位整型>64位整型</h3>
<pre tabindex=0><code>    _G = {
        uint64 = {
            tostring = i64lib.c的 uint64_tostring 方法
            compare = i64lib.c的 uint64_compare 方法
            divide = i64lib.c的 uint64_divide 方法
            remainder = i64lib.c的 uint64_remainder 方法
            parse = i64lib.c的 uint64_parse 方法
        }
    }

    -10000（即 LUA_REGISTRYINDEX） = {
        ...

        -- 5.1.5版本才有
        8（即 INT64_META_REF） = {
            __add = i64lib.c的 int64_add 方法
            __sub = i64lib.c的 int64_sub 方法
            __mul = i64lib.c的 int64_mul 方法
            __div = i64lib.c的 int64_div 方法
            __mod = i64lib.c的 int64_mod 方法
            __unm = i64lib.c的 int64_unm 方法
            __pow = i64lib.c的 int64_pow 方法
            __tostring = i64lib.c的 int64_tostring 方法
            __eq = i64lib.c的 int64_eq 方法
            __lt = i64lib.c的 int64_lt 方法
            __le = i64lib.c的 int64_le 方法
            __tostring = i64lib.c的 int64_tostring 方法
        }

    }
</code></pre><h3 id=协程>协程</h3>
<h3 id=接口interface>接口（Interface）</h3>
<h3 id=热修复>热修复</h3>
<h2 id=总结>总结</h2>
<hr>
<ul class=pager>
<li class=previous>
<a href=/post/lua/lua_tolua/ data-toggle=tooltip data-placement=top title="Lua篇 — (2) ToLua">&larr;
Previous Post</a>
</li>
</ul>
<div id=disqus-comment></div>
</div>
<div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container">
<div class=side-catalog>
<hr class="hidden-sm hidden-xs">
<h5>
<a class=catalog-toggle href=#>CATALOG</a>
</h5>
<ul class=catalog-body></ul>
</div>
</div>
<div class="col-lg-11 col-lg-offset-1
col-md-10 col-md-offset-1
sidebar-container">
</div>
</div>
</div>
</article>
<footer>
<div class=container>
<div class=row>
<div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
<ul class="list-inline text-center">
</ul>
<p class="copyright text-muted">
Copyright &copy; Xun's Blog 2021
<br>
<a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> by <a href=https://zhaohuabing.com>Huabing</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe>
</p>
</div>
</div>
</div>
</footer>
<script>function loadAsync(f,b){var c=document,d='script',a=c.createElement(d),e=c.getElementsByTagName(d)[0];a.src=f,b&&a.addEventListener('load',function(a){b(null,a)},!1),e.parentNode.insertBefore(a,e)}</script>
<script>$('#tag_cloud').length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:'#bbbbee',end:'#0085a1'}},$('#tag_cloud a').tagcloud()})</script>
<script>loadAsync("https://cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.js",function(){var a=document.querySelector("nav");a&&FastClick.attach(a)})</script>
<script type=text/javascript>function generateCatalog(a){_containerSelector='div.post-container';var h=$(_containerSelector),c,d,e,f,g,b;return c=h.find('h1,h2,h3,h4,h5,h6'),$(a).html(''),c.each(function(){d=$(this).prop('tagName').toLowerCase(),g="#"+$(this).prop('id'),e=$(this).text(),b=$('<a href="'+g+'" rel="nofollow">'+e+'</a>'),f=$('<li class="'+d+'_nav"></li>').append(b),$(a).append(f)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(a){a.preventDefault(),$('.side-catalog').toggleClass("fold")}),loadAsync("/js/jquery.nav.js",function(){$('.catalog-body').onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script>
</body>
</html>